apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: kyverno-protect-protected-namespaces
spec:
  validationFailureAction: Enforce
  background: false
  rules:
    - name: block-delete-protected-ns
      match: {any: [{resources: {kinds: ["Namespace"]}}]}
      preconditions:
        all:
          - key: "{{ request.operation }}"
            operator: Equals
            value: "DELETE"
      validate:
        message: "Namespace protégé: retirez l’annotation nudger.logo-solutions.fr/protect=true via GitOps avant suppression."
        deny:
          conditions:
            any:
              - key: "{{ request.oldObject.metadata.annotations.\"nudger.logo-solutions.fr/protect\" }}"
                operator: Equals
                value: "true"

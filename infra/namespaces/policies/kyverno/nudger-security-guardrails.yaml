apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: kyverno-nudger-security-guardrails
spec:
  validationFailureAction: Enforce
  background: false
  rules:
    # 1) Exiger une justification dès qu'on utilise une exception
    - name: require-justification-for-exceptions
      match:
        any:
          - resources:
              kinds: ["Pod"]
              selector:
                matchExpressions:
                  - key: security.nudger/allow-rw-rootfs
                    operator: In
                    values: ["true"]
                  - key: security.nudger/allow-init-root
                    operator: In
                    values: ["true"]
      validate:
        message: "Exception sécurité sans justification: ajoutez annotation security.nudger/justification."
        pattern:
          metadata:
            annotations:
              security.nudger/justification: "?*"
    # 2) Auto-harden par défaut (opt-in RW possible via label)
    - name: auto-harden
      match:
        any:
          - resources:
              kinds: ["Pod"]
      exclude:
        any:
          - resources:
              namespaces: ["longhorn-system", "ingress-nginx", "logging", "kyverno"]
      mutate:
        patchStrategicMerge:
          spec:
            automountServiceAccountToken: false
            containers:
              - (name): "*"
                securityContext:
                  allowPrivilegeEscalation: false
                  capabilities: {drop: ["ALL"]}
                  readOnlyRootFilesystem: true
                  runAsNonRoot: true
            securityContext:
              runAsNonRoot: true
              runAsUser: 10001
              runAsGroup: 10001
              seccompProfile: {type: RuntimeDefault}
    # 3) Forcer RO si pas d’opt-in explicite
    - name: enforce-ro-rootfs
      match:
        any:
          - resources:
              kinds: ["Pod"]
      exclude:
        any:
          - resources:
              namespaces: ["longhorn-system", "ingress-nginx", "logging", "kyverno"]
      preconditions:
        all:
          - key: "{{ request.object.metadata.labels.\"security.nudger/allow-rw-rootfs\" || 'false' }}"
            operator: Equals
            value: "false"
      mutate:
        foreach:
          - list: "request.object.spec.containers"
            patchStrategicMerge:
              spec:
                containers:
                  - name: "{{ element.name }}"
                    securityContext:
                      readOnlyRootFilesystem: true
    # 4) Injecter un init root standard quand autorisé
    - name: inject-root-init-when-allowed
      match:
        any:
          - resources:
              kinds: ["Pod"]
              selector:
                matchLabels:
                  security.nudger/allow-init-root: "true"
      exclude:
        any:
          - resources:
              namespaces: ["longhorn-system", "ingress-nginx", "logging", "kyverno"]
      mutate:
        patchStrategicMerge:
          spec:
            initContainers:
              - name: nudger-perms
                image: busybox:1.36
                command:
                  - sh
                  - -lc
                  - >
                    for d in /var/cache/nginx /var/run /var/log/nginx; do mkdir -p $d; chown -R 101:101 $d; chmod -R 0775 $d; done

                securityContext:
                  runAsUser: 0
                  allowPrivilegeEscalation: false
                  seccompProfile: {type: RuntimeDefault}

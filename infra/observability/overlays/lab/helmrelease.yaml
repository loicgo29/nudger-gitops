apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: observability
spec:
  interval: 10m
  chart:
    spec:
      chart: kube-prometheus-stack
      version: 61.x.x
      sourceRef:
        kind: HelmRepository
        name: prometheus-community
        namespace: flux-system
  install:
    createNamespace: false
    remediation: { retries: 3 }
  upgrade:
    remediation: { retries: 3 }
  values:
    kubeScheduler:
      service:
        enabled: false
      serviceMonitor:
        enabled: false
    alertmanager:
      enabled: false
    grafana:
      grafana.ini:
        explore:
          logsPanel:
            defaultLogVolumeEnabled: false
      enabled: false
      defaultDashboardsTimezone: "Europe/Paris"
      service:
        type: ClusterIP
      additionalDataSources:
        - name: Loki
          type: loki
          access: proxy
          url: http://loki.logging.svc.cluster.local:3100
          isDefault: false
    kubeStateMetrics:
      enabled: false
    prometheus:
      service:
        type: ClusterIP
      prometheusSpec:
        retention: 2h               # avant: 15d+ par défaut => trop
        retentionSize: "1GB"         # borne dure d’espace
        walCompression: true
        scrapeInterval: 60s          # passe de 30s à 60s
        evaluationInterval: 60s
        resources:
          requests:
            cpu: 50m
            memory: 200Mi
          limits:
            memory: 400Mi
        enableAdminAPI: false
      # Désactive des targets verbeuses pour soulager apiserver/etcd :
        additionalScrapeConfigs: []
        readinessProbe:
          timeoutSeconds: 5
          periodSeconds: 10
          failureThreshold: 12
          initialDelaySeconds: 60
        livenessProbe:
          timeoutSeconds: 5
          periodSeconds: 10
          failureThreshold: 12
          initialDelaySeconds: 90
    kube-state-metrics:
      podAnnotations: {}
    # Le chart ne donne pas toutes les knobs des probes en premier niveau;
    # on passe par extraArgs pour laisser le temps à /readyz
      extraArgs:
        - --telemetry-port=8081
      resources:
        requests:
          cpu: 50m
          memory: 50Mi
        limits:
          memory: 150Mi
    nodeExporter:
      hostNetwork: false
      hostPID: false
      resources:
        requests:
          cpu: 10m
          memory: 20Mi
        limits:
          memory: 50Mi

name: "PR: Flux image updates (unique)"

on:
  push:
    branches:
      - flux-imageupdates
  workflow_dispatch:
    inputs:
      head_branch:
        description: "Source branch (default: flux-imageupdates)"
        required: false
        default: flux-imageupdates

permissions:
  contents: write
  pull-requests: write
  issues: write

concurrency:
  group: auto-pr-flux-unique-${{ github.run_id }}
  cancel-in-progress: true

jobs:
  create-unique-pr:
    runs-on: ubuntu-latest
    env:
      BASE_BRANCH: main

    steps:
      - name: Determine HEAD branch (push vs manual)
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.head_branch }}" ]; then
            echo "HEAD_BRANCH=${{ github.event.inputs.head_branch }}" >> "$GITHUB_ENV"
          else
            echo "HEAD_BRANCH=${{ github.ref_name }}" >> "$GITHUB_ENV"
          fi
          echo "Using HEAD_BRANCH=$(sed -n 's/^HEAD_BRANCH=//p' $GITHUB_ENV)"

      - name: Checkout repository (default branch)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch branches & show SHAs
        run: |
          set -euo pipefail
          git fetch origin "+refs/heads/*:refs/remotes/origin/*"
          echo "BASE_BRANCH=${BASE_BRANCH}  HEAD_BRANCH=${HEAD_BRANCH}"
          echo "origin/${BASE_BRANCH}  -> $(git rev-parse origin/${BASE_BRANCH})"
          echo "origin/${HEAD_BRANCH}   -> $(git rev-parse origin/${HEAD_BRANCH})" || true
          echo "Ahead count (origin/${BASE_BRANCH}..origin/${HEAD_BRANCH}):" \
            $(git rev-list --count "origin/${BASE_BRANCH}..origin/${HEAD_BRANCH}" || echo 0)

      - name: Ensure HEAD (remote) has commits ahead of BASE
        run: |
          set -euo pipefail
          if ! git rev-parse --verify "origin/${HEAD_BRANCH}" >/dev/null 2>&1; then
            echo "La branche distante origin/${HEAD_BRANCH} n'existe pas. Rien à PR."
            exit 0
          fi
          AHEAD=$(git rev-list --count "origin/${BASE_BRANCH}..origin/${HEAD_BRANCH}")
          echo "Commits ahead (origin/${BASE_BRANCH}..origin/${HEAD_BRANCH}) = ${AHEAD}"
          if [ "${AHEAD}" -eq 0 ]; then
            echo "Aucun commit 'ahead' côté Flux. Exit propre (pas de PR)."
            exit 0
          fi

      - name: Create unique branch from remote HEAD
        run: |
          set -euo pipefail
          SRC_SHA="$(git rev-parse origin/${HEAD_BRANCH})"
          SHORT_SHA="${SRC_SHA:0:7}"
          STAMP="$(date +%Y%m%d-%H%M%S)"
          NEW_BRANCH="${HEAD_BRANCH}-${SHORT_SHA}-${STAMP}"
          echo "NEW_BRANCH=${NEW_BRANCH}" >> "$GITHUB_ENV"

          git switch --detach "origin/${HEAD_BRANCH}"
          git checkout -b "${NEW_BRANCH}"
          echo "New branch at $(git rev-parse HEAD) (should equal ${SRC_SHA})"
          git push origin "${NEW_BRANCH}:${NEW_BRANCH}"
          echo "Created & pushed ${NEW_BRANCH}"

      - name: Ensure labels exist (idempotent)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh label create flux --color FFD700 --description "Flux automation" \
            || gh label edit flux --color FFD700 --description "Flux automation"
          gh label create automated-pr --color 1D76DB --description "Created by automation" \
            || gh label edit automated-pr --color 1D76DB --description "Created by automation"

      - name: Open PR from unique branch to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          gh pr create \
            --head "${NEW_BRANCH}" \
            --base "${BASE_BRANCH}" \
            --title "chore(images): Flux updates (${NEW_BRANCH})" \
            --body "PR auto générée depuis \`${NEW_BRANCH}\` (bump d’images via Flux)." \
            --label flux --label automated-pr
          gh pr list --head "${NEW_BRANCH}" --base "${BASE_BRANCH}" --state open \
            --json number,url -q '.[0] | "PR #"+(.number|tostring)+" → "+.url'


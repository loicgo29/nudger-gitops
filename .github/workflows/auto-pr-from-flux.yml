name: "PR: Flux image updates"

on:
  push:
    branches:
      - flux-imageupdates
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-pr-flux-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout branch that triggered the workflow
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
          fetch-depth: 0

      - name: Ensure PR exists (from branch → main)
        env:
          GH_TOKEN: ${{ github.token }}
          HEAD_BRANCH: ${{ github.ref_name }}
          BASE_BRANCH: main
        run: |
          set -euo pipefail
          echo "HEAD=$HEAD_BRANCH BASE=$BASE_BRANCH"

          # Si une PR existe déjà pour cette branche → OK (ouvre rien).
          if gh pr view --head "$HEAD_BRANCH" --base "$BASE_BRANCH" >/dev/null 2>&1; then
            echo "PR already exists for $HEAD_BRANCH -> $BASE_BRANCH."
            # Si fermée, on la rouvre
            state=$(gh pr view --head "$HEAD_BRANCH" --base "$BASE_BRANCH" --json state -q .state || echo "")
            if [ "$state" = "CLOSED" ]; then
              gh pr reopen --head "$HEAD_BRANCH" --base "$BASE_BRANCH"
              echo "Reopened existing PR."
            fi
          else
            # Créer la PR
            gh pr create \
              --head "$HEAD_BRANCH" \
              --base "$BASE_BRANCH" \
              --title "chore(images): updates from Flux" \
              --body "PR auto générée depuis \`$HEAD_BRANCH\` (bump images via Flux)." \
              --label flux,automated-pr
            echo "PR created."
          fi

          # Petit log sympa
          gh pr view --head "$HEAD_BRANCH" --base "$BASE_BRANCH" --json number,url -q '"PR #" + ( .number | tostring ) + " → " + .url'


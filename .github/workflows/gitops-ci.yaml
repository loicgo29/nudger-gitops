name: GitOps CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sanitycheck:
    name: Sanitycheck ARC
    runs-on: ubuntu-latest
    env:
      KUBECONFIG: ${{ github.workspace }}/kubeconfig

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Restore kubeconfig
        run: |
          echo "$KUBECONFIG_B64" | base64 -d > "$KUBECONFIG"
          echo "âœ… Kubeconfig restaurÃ© dans $KUBECONFIG"
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG_B64 }}

      - name: Install tools
        run: |
          set -eux
          mkdir -p ~/.local/bin
          curl -sLo ~/.local/bin/kustomize https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv5.4.2/kustomize_v5.4.2_linux_amd64.tar.gz
          tar -xzf ~/.local/bin/kustomize -C ~/.local/bin || true
          curl -sLo ~/.local/bin/kubeconform https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz
          tar -xzf ~/.local/bin/kubeconform -C ~/.local/bin || true
          chmod +x ~/.local/bin/*
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Check kustomizations
        run: |
          for cluster in clusters/*; do
            echo "ğŸ”§ Building $cluster"
            kustomize build "$cluster" >/dev/null
          done

      - name: Validate manifests with kubeconform
        run: |
          for cluster in clusters/*; do
            echo "ğŸ” Validating $cluster"
            kustomize build "$cluster" | kubeconform -strict -ignore-missing-schemas -summary
          done

      - name: Dry-run apply manifests
        run: |
          for cluster in clusters/*; do
            echo "ğŸš€ Dry-run for $cluster"
            kubectl apply --dry-run=server -f <(kustomize build "$cluster")
          done

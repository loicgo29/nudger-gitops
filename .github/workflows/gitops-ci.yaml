# .github/workflows/gitops-ci.yaml
name: GitOps CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read

jobs:
  sanitycheck:
    name: Sanitycheck ARC
    runs-on: [self-hosted, nudger-gitops, recette] # ğŸ‘ˆ exÃ©cute sur ton runner ARC
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache binaries
        id: cache-bin
        uses: actions/cache@v4
        with:
          path: ~/.local/bin
          key: ${{ runner.os }}-gitops-tools-v2

      - name: Install tools (kubectl, kustomize, kubeconform)
        if: steps.cache-bin.outputs.cache-hit != 'true'
        run: |
          set -eux
          chmod +x scripts/ci/install-tools.sh
          scripts/ci/install-tools.sh

      - name: Add ~/.local/bin to PATH
        run: echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Check kustomizations (build only)
        run: |
          set -eux
          for cluster in clusters/*; do
            echo "ğŸ”§ Checking $cluster"
            kustomize build "$cluster" >/dev/null
          done

      - name: Validate manifests with kubeconform
        run: |
          set -eux
          for cluster in clusters/*; do
            echo "ğŸ” Validating $cluster"
            kustomize build "$cluster" | kubeconform \
              -strict \
              -ignore-missing-schemas \
              -summary
          done

      - name: Dry-run apply manifests
        run: |
          set -eux
          for cluster in clusters/*; do
            echo "ğŸš€ Dry-run for $cluster"
            kustomize build "$cluster" | kubectl apply --dry-run=client -f -
          done

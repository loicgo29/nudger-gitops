name: "Bump MULTI (manual)"

on:
  workflow_dispatch:
    inputs:
      kind:
        description: "helm ou kustomize"
        required: true
        type: choice
        options: [helm, kustomize]
      paths:
        description: "Fichiers séparés par virgules (ex: apps/a/values.yaml, apps/b/kustomization.yaml)"
        required: true
        type: string
      image_repo:
        description: "Repo d'image publique (ex: traefik/whoami)"
        required: true
        type: string
      image_tag:
        description: "Tag (ex: v1.10.1)"
        required: true
        type: string
      name:
        description: "images[].name si kind=kustomize (ex: whoami)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: bump-multi-${{ github.event.inputs.kind }}-${{ github.event.inputs.paths }}
  cancel-in-progress: true

jobs:
  bump:
    runs-on: ubuntu-latest
    env:
      KIND:  ${{ inputs.kind }}
      FILES: ${{ inputs.paths }}
      REPO:  ${{ inputs.image_repo }}
      TAG:   ${{ inputs.image_tag }}
      NAME:  ${{ inputs.name }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install deps (yq + kustomize + kubeconform si besoin)
        shell: bash
        run: |
          set -euo pipefail
          # yq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          yq --version
          # kustomize + kubeconform uniquement si kind=kustomize
          if [[ "${KIND}" == "kustomize" ]]; then
            KVER=5.4.2
            curl -fsSL -o /tmp/kustomize.tgz "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv${KVER}/kustomize_v${KVER}_linux_amd64.tar.gz"
            tar -xzf /tmp/kustomize.tgz -C /tmp kustomize && sudo mv /tmp/kustomize /usr/local/bin/kustomize
            kustomize version
            KCF=0.6.7
            curl -fsSL -o /tmp/kc.tgz "https://github.com/yannh/kubeconform/releases/download/v${KCF}/kubeconform-linux-amd64.tar.gz"
            tar -xzf /tmp/kc.tgz -C /tmp kubeconform && sudo mv /tmp/kubeconform /usr/local/bin/kubeconform
            kubeconform -v
          fi

      - name: Patch files (script source de vérité)
        id: bump
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/kustomize/bump-multi.sh
          scripts/kustomize/bump-multi.sh \
            --kind  "${KIND}" \
            --paths "${FILES}" \
            --image-repo "${REPO}" \
            --image-tag  "${TAG}" \
            ${NAME:+--name "${NAME}"}

      - name: Create PR
        if: steps.bump.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(multi): ${{ inputs.image_repo }}:${{ inputs.image_tag }}"
          title: "chore(multi): bump to ${{ inputs.image_repo }}:${{ inputs.image_tag }}"
          body: |
            kind:  `${{ inputs.kind }}`
            repo:  `${{ inputs.image_repo }}`
            tag:   `${{ inputs.image_tag }}`
            name:  `${{ inputs.name }}`
            files: `${{ steps.bump.outputs.files }}`
          branch: chore/bump-multi-${{ inputs.kind }}-${{ github.run_id }}
          labels: |
            auto
            bump

      - name: No changes
        if: steps.bump.outputs.changed != 'true'
        run: echo "Aucun fichier patché (déjà à jour ou fichiers manquants)."

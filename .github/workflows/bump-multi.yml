name: "Bump MULTI (manual)"

on:
  workflow_dispatch:
    inputs:
      kind:
        description: "helm ou kustomize"
        required: true
        type: choice
        options: [helm, kustomize]
      paths:
        description: "Fichiers séparés par virgules"
        required: true
        type: string
      image_repo:
        description: "Repo d'image publique"
        required: true
        type: string
      image_tag:
        description: "Tag (ex: v1.10.1)"
        required: true
        type: string
      name:
        description: "images[].name si kind=kustomize"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: bump-multi-${{ github.event.inputs.kind }}-${{ github.event.inputs.paths }}
  cancel-in-progress: true

jobs:
  bump:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install deps
        run: |
          set -euo pipefail
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          if [[ "${{ inputs.kind }}" == "kustomize" ]]; then
            KVER=5.4.2
            curl -fsSL -o /tmp/kustomize.tgz "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv${KVER}/kustomize_v${KVER}_linux_amd64.tar.gz"
            tar -xzf /tmp/kustomize.tgz -C /tmp kustomize && sudo mv /tmp/kustomize /usr/local/bin/kustomize
            KCF=0.6.7
            curl -fsSL -o /tmp/kc.tgz "https://github.com/yannh/kubeconform/releases/download/v${KCF}/kubeconform-linux-amd64.tar.gz"
            tar -xzf /tmp/kc.tgz -C /tmp kubeconform && sudo mv /tmp/kubeconform /usr/local/bin/kubeconform
          fi

      - name: Patch files
        run: |
          chmod +x scripts/kustomize/bump-multi.sh
          scripts/kustomize/bump-multi.sh             --kind "${{ inputs.kind }}"             --paths "${{ inputs.paths }}"             --image-repo "${{ inputs.image_repo }}"             --image-tag "${{ inputs.image_tag }}"             ${{ inputs.name && format('--name {0}', inputs.name) }}

      - name: Create PR
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(multi): ${{ inputs.image_repo }}:${{ inputs.image_tag }}"
          title: "chore(multi): bump to ${{ inputs.image_repo }}:${{ inputs.image_tag }}"
          body: "Automated bump"
          branch: chore/bump-multi-${{ inputs.kind }}-${{ github.run_id }}
          labels: auto, bump

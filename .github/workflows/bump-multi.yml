name: "Bump MULTI (manual)"

on:
  workflow_dispatch:
    inputs:
      kind:
        description: "helm ou kustomize"
        required: true
        type: choice
        options: [helm, kustomize]
      paths:
        description: "Fichiers séparés par virgules"
        required: true
        type: string
      image_repo:
        description: "Repo d'image publique"
        required: true
        type: string
      image_tag:
        description: "Tag (ex: v1.10.1)"
        required: true
        type: string
      name:
        description: "images[].name si kind=kustomize"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: bump-multi-${{ github.event.inputs.kind }}-${{ github.event.inputs.paths }}
  cancel-in-progress: true

jobs:
  bump:
    runs-on: ubuntu-latest
    env:
      KIND:  ${{ inputs.kind }}
      FILES: ${{ inputs.paths }}
      REPO:  ${{ inputs.image_repo }}
      TAG:   ${{ inputs.image_tag }}
      NAME:  ${{ inputs.name }}

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Install tools
        run: |
          if [[ "${KIND}" == "kustomize" ]]; then
            INSTALL_KUSTOMIZE=1 INSTALL_KUBECONFORM=1 bash scripts/github_workflows/install-tools.sh
          else
            bash scripts/github_workflows/install-tools.sh
          fi

      - name: Patch files
        id: bump
        run: |
          chmod +x scripts/kustomize/bump-multi.sh
          scripts/kustomize/bump-multi.sh \
            --kind  "${KIND}" \
            --paths "${FILES}" \
            --image-repo "${REPO}" \
            --image-tag  "${TAG}" \
            ${NAME:+--name "${NAME}"}

      - name: Create PR
        if: steps.bump.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(multi): ${{ inputs.image_repo }}:${{ inputs.image_tag }}"
          title: "chore(multi): bump to ${{ inputs.image_repo }}:${{ inputs.image_tag }}"
          body: |
            kind:  `${{ inputs.kind }}`
            repo:  `${{ inputs.image_repo }}`
            tag:   `${{ inputs.image_tag }}`
            name:  `${{ inputs.name }}`
            files: `${{ steps.bump.outputs.files }}`
          branch: chore/bump-multi-${{ inputs.kind }}-${{ github.run_id }}
          labels: auto, bump

      - name: No changes
        if: steps.bump.outputs.changed != 'true'
        run: echo "Aucun fichier patché (déjà à jour ou fichiers manquants)."

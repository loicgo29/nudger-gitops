name: üîç Trivy (K8s Manifests)    # Nom affich√© du workflow dans GitHub Actions

on:
  pull_request:                  # D√©clench√© sur chaque PR
    paths:                       # ... mais seulement si les fichiers modifi√©s correspondent √† :
      - 'apps/**'                # -> Manifests des apps
      - 'clusters/**'            # -> Manifests des clusters
      - '**/*.yaml'              # -> Tous les YAML
  workflow_dispatch:             # Et ex√©cutable √† la main depuis l‚ÄôUI GitHub

permissions:
  contents: read                 # Lecture du repo uniquement
  security-events: write         # √âcriture pour publier les r√©sultats de s√©curit√© (SARIF)

jobs:
  trivy-k8s:
    runs-on: ubuntu-latest       # Runner GitHub standard
    steps:
      - uses: actions/checkout@v4  # R√©cup√®re le code du repo

      - name: Cache Trivy DB
        uses: actions/cache@v4     # Mise en cache de la base vuln√©rabilit√©s Trivy
        with:
          path: ~/.cache/trivy     # R√©pertoire local utilis√© par Trivy
          key: trivy-db-${{ runner.os }}-${{ hashFiles('**/*.yaml') }}
                                   # Cl√© de cache d√©pendant du contenu YAML
          restore-keys: trivy-db-${{ runner.os }}-
                                   # Fallback si la cl√© exacte n‚Äôexiste pas

      - name: Run Trivy (misconfig + secrets)
        run: ./scripts/ci/ci-on-pr/trivy-k8s.sh .
                                   # -> Analyse Kubernetes Manifests + secrets
                                   # -> √âchoue si CRITICAL/HIGH trouv√©s
      - name: SARIF (misconfig)
        if: always()
        run: |
          set -euo pipefail
          echo "‚ñ∂ G√©n√©ration du rapport SARIF"
          trivy config . \
            --format sarif \
            --output trivy-k8s.sarif \
            --exit-code 0 \
            --skip-dirs "smoke-tests" \
            --ignorefile .trivyignore || true
          ls -lh trivy-k8s.sarif || echo "‚ö†Ô∏è Pas de fichier SARIF g√©n√©r√©"
      - name: Upload SARIF
        if: always() && hashFiles('trivy-k8s.sarif') != ''
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-k8s.sarif
  trivy-images:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Cache Trivy DB
        uses: actions/cache@v4
        with:
          path: ~/.cache/trivy
          key: trivy-db-${{ runner.os }}-images-${{ hashFiles('apps/**/kustomization.yaml') }}
          restore-keys: trivy-db-${{ runner.os }}-images-

      - name: Run Trivy (all images in apps)
        run: |
          TRIVY_SEVERITY="CRITICAL,HIGH" TRIVY_EXIT_CODE=1 \
          ./scripts/ci/ci-on-pr/trivy.sh images-in-apps apps

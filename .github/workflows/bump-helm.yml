name: "🔧 Bump HELM image (manual)"

on:
  workflow_dispatch:
    inputs:
      path:
        description: "Fichier values.yaml (ex: clusters/lab/apps/xwiki/values.yaml)"
        required: true
        type: string
      image_repo:
        description: "Repo d'image public (ex: traefik/whoami)"
        required: true
        type: string
      image_tag:
        description: "Tag (ex: v1.10.1)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  bump:                    # ⬅️ le job est SOUS 'jobs'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install yq
        run: |              # ⬅️ le script est indenté SOUS 'run:'
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.3/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Patch values.yaml
        id: patch
        env:
          FILE: ${{ inputs.path }}
          REPO: ${{ inputs.image_repo }}
          TAG:  ${{ inputs.image_tag }}
        run: |
          set -euo pipefail
          test -f "$FILE" || { echo "Fichier introuvable: $FILE"; exit 1; }
          yq -i '.image.repository = env(REPO) | .image.tag = env(TAG)' "$FILE"
          echo "file=$FILE" >> "$GITHUB_OUTPUT"

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(helm): ${{ inputs.image_repo }}:${{ inputs.image_tag }}"
          title: "chore(helm): bump to ${{ inputs.image_repo }}:${{ inputs.image_tag }}"
          body: "Path: `${{ steps.patch.outputs.file }}`"
          branch: chore/helm-bump-${{ github.run_id }}
          labels: |
            auto
            helm


name: CI — Kustomize + Kubeconform (via script)

on:
  pull_request:
    branches: [ main ]
    # (Optionnel) Ne déclencher que si des dossiers kustomize changent
    # paths:
    #   - "apps/**"
    #   - "clusters/**"
    #   - "scripts/github_workflows/**"
  workflow_dispatch: {}

# Principe de moindre privilège
permissions:
  contents: read
  # pull-requests: write  # <-- décommente si plus tard tu postes des commentaires/annotations sur la PR

# Évite les runs concurrents sur la même PR
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    env:
      # Versions utilisées par TON script si install nécessaire
      KUSTOMIZE_VERSION: "5.4.2"
      KUBECONFORM_VERSION: "0.6.7"
      # Active/désactive des blocs de vérif dans le script
      CHECK_WHOAMI: "1"
      CHECK_INGRESS_LAB: "1"
      # (Optionnel) Forcer des chemins si l’arbo change
      # WHOAMI_DIR: "apps/whoami"
      # INGRESS_LAB_DIR: "apps/ingress-nginx/overlays/lab"
      # (Optionnel) Forcer la racine si exécuté ailleurs que dans le repo
      # REPO_ROOT_OVERRIDE: "${{ github.workspace }}"

    steps:
      - name: Checkout (full history for robust scripts)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # utile si le script regarde l’historique ou les tags

      - name: Run CI validations (script source de vérité)
        working-directory: ${{ github.workspace }}
        shell: bash
        run: |
          set -euo pipefail
          chmod +x scripts/github_workflows/ci-on-pr.sh
          scripts/github_workflows/ci-on-pr.sh

      # (Optionnel mais utile) Exporter les manifests buildés pour debug si ça casse
      # Ton script écrit /tmp/whoami.yaml et /tmp/ingress.yaml : on les embarque en artefacts
      - name: Upload kustomize outputs (debug)
        if: failure() || always()
        uses: actions/upload-artifact@v4
        with:
          name: kustomize-builds
          path: |
            /tmp/whoami.yaml
            /tmp/ingress.yaml
          if-no-files-found: ignore

name: "CI: validate manifests on PR"

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  issues: write  

concurrency:
  group: ci-on-pr-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install kustomize
        run: |
          set -e
          KVER="v5.4.2"
          URL="https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F${KVER}/kustomize_${KVER#v}_linux_amd64.tar.gz"
          echo "Downloading $URL"
          curl -fsSL "$URL" -o kustomize.tgz
          test -s kustomize.tgz
          file kustomize.tgz | grep -qi 'gzip compressed data'
          tar -xzf k.tar.gz
          sudo mv kustomize /usr/local/bin/kustomize
          kustomize version

      - name: Install kubeconform (optional)
        run: |
          set -e
          URL="https://github.com/yannh/kubeconform/releases/download/${KCONF_VER}/kubeconform-linux-amd64.tar.gz"
          echo "Downloading $URL"
          curl -fsSL "$URL" -o kubeconform.tgz
          test -s kubeconform.tgz
          file kubeconform.tgz | grep -qi 'gzip compressed data'
          kubeconform -v || echo "kubeconform not found; continuing"

      - name: Kustomize build (apps/whoami)
        run: |
          set -e
          if [ -d "apps/whoami" ]; then
            kustomize build apps/whoami >/dev/null
            echo "apps/whoami ✅"
          else
            echo "apps/whoami not found (skipped)"
          fi

      - name: Kustomize build (ingress-nginx overlay lab)
        run: |
          set -e
          if [ -d "apps/ingress-nginx/overlays/lab" ]; then
            kustomize build apps/ingress-nginx/overlays/lab >/dev/null
            echo "apps/ingress-nginx/overlays/lab ✅"
          else
            echo "apps/ingress-nginx/overlays/lab not found (skipped)"
          fi

      - name: kubeconform validate (if available)
        run: |
          set -e
          if command -v kubeconform >/dev/null 2>&1; then
            # Valide what we can; ignore CRDs unknown to schemas by default
            if [ -d "apps/whoami" ]; then
              kustomize build apps/whoami | kubeconform -strict -summary -ignore-missing-schemas
            fi
            if [ -d "apps/ingress-nginx/overlays/lab" ]; then
              kustomize build apps/ingress-nginx/overlays/lab | kubeconform -strict -summary -ignore-missing-schemas
            fi
          else
            echo "kubeconform not installed; skipping validation."
          fi


# ğŸš‘ Recette anti-blocage FluxCD

## 1. Respecter lâ€™ordre de dÃ©ploiement
Toujours sÃ©parer les `Kustomization` avec des dÃ©pendances explicites :

1. **Namespaces** (`infra/namespaces`)  
   - Chaque namespace doit exister **avant** dâ€™y crÃ©er des ressources (Secrets, HelmRelease, etc.).  
   - Solution : un `meta-infra-namespaces` appliquÃ© en premier.  

2. **CRDs & Operators**  
   - Ex : SealedSecrets, Cert-Manager, Kyverno.  
   - âš ï¸ Les CRDs doivent Ãªtre prÃ©sentes **avant** dâ€™appliquer des objets qui les utilisent (ex : `SealedSecret`).  

3. **Repositories (sources)**  
   - HelmRepository (charts), GitRepository (autres repos).  
   - Ils doivent Ãªtre `Ready` avant que les HelmRelease qui sâ€™y rÃ©fÃ¨rent dÃ©marrent.  

4. **HelmRelease / Apps**  
   - Installations dâ€™applications (ARC, Prometheus, etc.).  

5. **SealedSecrets dÃ©pendants**  
   - Les secrets scellÃ©s doivent attendre que le namespace ET le controller soient prÃªts.

---

## 2. Structurer les `Kustomization`
Dans tes manifests Flux (`clusters/*`), ajoute **`dependsOn`** pour forcer lâ€™ordre :  

```yaml
apiVersion: kustomize.toolkit.fluxcd.io/v1
kind: Kustomization
metadata:
  name: actions-runner-controller
  namespace: flux-system
spec:
  dependsOn:
    - name: meta-infra-namespaces       # les namespaces existent
    - name: cert-manager                # cert-manager prÃªt pour gÃ©rer les certifs
  path: ./infra/action-runner-controller/base
  prune: true
  wait: true
  interval: 10m
  sourceRef:
    kind: GitRepository
    name: flux-system
```

---

## 3. VÃ©rifications avant `flux reconcile`
Checklist :
```bash
# VÃ©rifier que le namespace cible existe
kubectl get ns actions-runner-system

# VÃ©rifier que les CRDs nÃ©cessaires sont bien installÃ©es
kubectl get crd | grep sealedsecrets
kubectl get crd | grep helmrepositories

# VÃ©rifier que les sources sont prÃªtes
kubectl -n flux-system get helmrepositories
```

---

## 4. Utiliser `flux reconcile` dans le bon ordre
Quand tu veux dÃ©bloquer manuellement :
```bash
flux reconcile kustomization meta-infra-namespaces -n flux-system --with-source
flux reconcile kustomization cert-manager -n flux-system --with-source
flux reconcile kustomization actions-runner-controller -n flux-system --with-source
```

âš ï¸ Toujours commencer par **namespaces â†’ CRDs â†’ HelmRepository â†’ HelmRelease**.  

---

## 5. Cas particulier : SealedSecrets
- La premiÃ¨re fois, il faut rÃ©cupÃ©rer la clÃ© publique :  
  ```bash
  kubeseal --controller-namespace=kube-system \
           --controller-name=sealed-secrets \
           --fetch-cert > pub-cert.pem
  ```
- Ensuite sceller tes secrets avec **le bon namespace et nom**.  
- Si un SealedSecret Ã©choue (`not found: namespace ...`), câ€™est que le namespace nâ€™Ã©tait pas crÃ©Ã© â†’ dÃ©pendance manquante.

---

## 6. âš¡ Conclusion
- **Flux est strict** : il refuse de dÃ©ployer tant que les dÃ©pendances ne sont pas â€œReadyâ€.  
- **kubectl apply est bourrin** : il balance tout et Ã§a finit par marcher.  
- La clÃ© â†’ **bien chaÃ®ner les Kustomizations avec `dependsOn`** pour que Flux sache attendre.  


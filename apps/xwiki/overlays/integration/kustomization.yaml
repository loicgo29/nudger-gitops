apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: ns-open4goods-integration

resources:
  - ../../base

patches:
  - target:
      kind: HelmRelease
      name: xwiki
    patch: |
      - op: replace
        path: /spec/values/externalDB
        value:
          type: mysql
          host: mysql-xwiki.ns-open4goods-integration.svc.cluster.local
          user: xwiki
          database: xwiki
          customKeyRef:
            enabled: true
            name: mysql-xwiki
            key: mysql-password
      - op: replace
        path: /spec/values/mysql/enabled
        value: false
      - op: replace
        path: /spec/values/mariadb/enabled
        value: false
      - op: replace
        path: /spec/values/postgresql/enabled
        value: false
  - target:
      kind: HelmRelease
      name: xwiki
    patch: |
      - op: replace
        path: /spec/values/image/tag
        value: 17.3.0-mysql-tomcat
      - op: replace
        path: /spec/values/database/host
        value: mysql-xwiki.ns-open4goods-integration.svc.cluster.local
      - op: add
        path: /spec/values/ingress
        value:
          enabled: true
          ingressClassName: nginx
          hosts:
            - host: xwiki.integration.nudger.logo-solutions.fr
              paths:
                - path: /
                  pathType: Prefix
          tls:
            - secretName: xwiki-tls
              hosts:
                - xwiki.integration.nudger.logo-solutions.fr

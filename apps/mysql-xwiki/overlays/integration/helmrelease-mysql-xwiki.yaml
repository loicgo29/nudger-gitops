apiVersion: helm.toolkit.fluxcd.io/v2beta2
kind: HelmRelease
metadata:
  name: mysql-xwiki-integration
  namespace: ns-open4goods-integration
spec:
  interval: 5m
  timeout: 10m
  install:
    remediation:
      retries: 3
    timeout: 10m
  upgrade:
    remediation:
      retries: 3
    timeout: 10m
  chart:
    spec:
      chart: mysql
      version: 11.1.9
      sourceRef:
        kind: HelmRepository
        name: helmrepo-bitnami
        namespace: flux-system
  values:
    auth:
      existingSecret: mysql-xwiki   # ðŸ‘ˆ utilisation du secret ci-dessus
      username: xwiki
      database: xwiki
      secretKeys:
        userPasswordKey: mysql-password
        rootPasswordKey: mysql-root-password
        userKey: mysql-user
        databaseKey: mysql-database
    primary:
      persistence:
        enabled: true
        storageClass: longhorn-db-integration
        size: 5Gi   # patch-pvc.yaml supprimÃ©

      resources:     # patch-resources.yaml supprimÃ©
        requests:
          cpu: "100m"
          memory: "256Mi"
        limits:
          cpu: "200m"
          memory: "512Mi"

      readinessProbe:   # patch-readiness.yaml supprimÃ©
        exec:
          command:
            - mysqladmin
            - ping
            - "-h"
            - "127.0.0.1"
            - "-uroot"
            - "-p$(MYSQL_ROOT_PASSWORD)"
        initialDelaySeconds: 60
        periodSeconds: 10
        timeoutSeconds: 5
        failureThreshold: 6
